<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>active/personal/calnix</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>body{padding:2rem} pre code {white-space: pre-wrap;}</style>
</head>
<body>
<div class="container">
  <nav class="mb-4"><a href="/">Megarepo pages</a> / active/personal/calnix</nav>
  <article>
    <h1 id="calnix-calvins-multi-host-nixos-configuration">Calnix - Calvin's Multi-Host NixOS Configuration</h1>
<p>A personal NixOS configuration supporting multiple hosts with modular architecture.</p>
<h2 id="hosts">Hosts</h2>
<h3 id="thinker-thinkpad">ğŸ–¥ï¸ Thinker (ThinkPad)</h3>
<p>Personal laptop configuration featuring:
- <strong>Window Manager</strong>: Sway (Wayland compositor)
- <strong>Gaming</strong>: Steam, game development tools, creative software
- <strong>Desktop Environment</strong>: Full desktop experience with Bluetooth, audio, etc.
- <strong>Power Management</strong>: ThinkPad-optimized TLP settings</p>
<h3 id="1337book-hp-elitebook">ğŸ’» 1337book (HP Elitebook)</h3>
<p>HP Elitebook X G1i 14 AI (896Y1UA ABA) configuration featuring:
- <strong>Window Manager</strong>: Sway (Wayland compositor)
- <strong>Gaming</strong>: Steam, Blender, Krita, Aseprite, Dwarf Fortress
- <strong>Desktop Environment</strong>: Full desktop experience with Bluetooth, audio, etc.
- <strong>Power Management</strong>: HP Elitebook-optimized TLP settings with thermal management
- <strong>Hardware</strong>: Latest kernel packages, HP-specific firmware updates via fwupd</p>
<h2 id="quick-start">Quick Start</h2>
<h3 id="for-thinkpad-thinker">For ThinkPad (Thinker)</h3>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>&lt;this-repo&gt;<span class="w"> </span>/etc/nixos
<span class="nb">cd</span><span class="w"> </span>/etc/nixos
sudo<span class="w"> </span>nixos-generate-config<span class="w"> </span>--show-hardware-config<span class="w"> </span>&gt;<span class="w"> </span>hosts/thinker/hardware-configuration.nix
./rebuild.sh<span class="w"> </span>thinker
</code></pre></div>

<h3 id="for-hp-elitebook-1337book">For HP Elitebook (1337book)</h3>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>&lt;this-repo&gt;<span class="w"> </span>/etc/nixos
<span class="nb">cd</span><span class="w"> </span>/etc/nixos
sudo<span class="w"> </span>nixos-generate-config<span class="w"> </span>--show-hardware-config<span class="w"> </span>&gt;<span class="w"> </span>hosts/1337book/hardware-configuration.nix
./rebuild.sh<span class="w"> </span>1337book
</code></pre></div>

<h2 id="testing">Testing</h2>
<p>Before deploying changes, run the comprehensive test suite:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Run all tests</span>
./tests/run_tests.sh

<span class="c1"># Quick validation only</span>
./tests/run_tests.sh<span class="w"> </span>--quick

<span class="c1"># Code quality checks only</span>
./tests/run_tests.sh<span class="w"> </span>--lint-only
</code></pre></div>

<h3 id="available-tests">Available Tests</h3>
<ul>
<li><strong>Configuration Validation</strong>: Checks file structure, imports, and gaming separation</li>
<li><strong>Rebuild Script Tests</strong>: Unit tests for host detection logic</li>
<li><strong>Nix Flake Validation</strong>: Syntax and build checks</li>
<li><strong>Code Quality</strong>: Linting and dead code detection</li>
<li><strong>Security</strong>: File permissions and basic security checks</li>
</ul>
<h3 id="individual-test-commands">Individual Test Commands</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># Test rebuild script logic</span>
./tests/test_rebuild.sh

<span class="c1"># Validate configuration structure</span>
./tests/validate_config.py

<span class="c1"># Nix-specific tests</span>
nix<span class="w"> </span>flake<span class="w"> </span>check<span class="w"> </span>--no-build
</code></pre></div>

<h2 id="architecture">Architecture</h2>
<div class="codehilite"><pre><span></span><code><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">flake</span><span class="p">.</span><span class="nx">nix</span><span class="w">              </span><span class="err">#</span><span class="w"> </span><span class="nx">Multi</span><span class="o">-</span><span class="nx">host</span><span class="w"> </span><span class="nx">flake</span><span class="w"> </span><span class="nx">configuration</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">rebuild</span><span class="p">.</span><span class="nx">sh</span><span class="w">             </span><span class="err">#</span><span class="w"> </span><span class="nx">Smart</span><span class="w"> </span><span class="nx">host</span><span class="o">-</span><span class="nx">aware</span><span class="w"> </span><span class="nx">rebuild</span><span class="w"> </span><span class="nx">script</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">hosts</span><span class="o">/</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">thinker</span><span class="o">/</span><span class="w">           </span><span class="err">#</span><span class="w"> </span><span class="nx">ThinkPad</span><span class="w"> </span><span class="nx">configuration</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">configuration</span><span class="p">.</span><span class="nx">nix</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">hardware</span><span class="o">-</span><span class="nx">configuration</span><span class="p">.</span><span class="nx">nix</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="mi">1337</span><span class="nx">book</span><span class="o">/</span><span class="w">          </span><span class="err">#</span><span class="w"> </span><span class="nx">HP</span><span class="w"> </span><span class="nx">Elitebook</span><span class="w"> </span><span class="nx">configuration</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">configuration</span><span class="p">.</span><span class="nx">nix</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">hardware</span><span class="o">-</span><span class="nx">configuration</span><span class="p">.</span><span class="nx">nix</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">modules</span><span class="o">/</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="kd">base</span><span class="p">.</span><span class="nx">nix</span><span class="w">           </span><span class="err">#</span><span class="w"> </span><span class="nx">Shared</span><span class="w"> </span><span class="kd">base</span><span class="w"> </span><span class="nx">configuration</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">desktop</span><span class="p">.</span><span class="nx">nix</span><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="nx">Desktop</span><span class="w"> </span><span class="nx">environment</span><span class="w"> </span><span class="p">(</span><span class="nx">Sway</span><span class="p">,</span><span class="w"> </span><span class="nx">Bluetooth</span><span class="p">,</span><span class="w"> </span><span class="nx">audio</span><span class="p">,</span><span class="w"> </span><span class="nx">etc</span><span class="p">.)</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">gaming</span><span class="p">.</span><span class="nx">nix</span><span class="w">         </span><span class="err">#</span><span class="w"> </span><span class="nx">Gaming</span><span class="o">-</span><span class="nx">specific</span><span class="w"> </span><span class="nx">packages</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">tests</span><span class="o">/</span><span class="w">                 </span><span class="err">#</span><span class="w"> </span><span class="nx">Testing</span><span class="w"> </span><span class="nx">infrastructure</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">run_tests</span><span class="p">.</span><span class="nx">sh</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="nx">Master</span><span class="w"> </span><span class="nx">test</span><span class="w"> </span><span class="nx">runner</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">test_rebuild</span><span class="p">.</span><span class="nx">sh</span><span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="nx">Rebuild</span><span class="w"> </span><span class="nx">script</span><span class="w"> </span><span class="nx">unit</span><span class="w"> </span><span class="nx">tests</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">validate_config</span><span class="p">.</span><span class="nx">py</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="nx">Configuration</span><span class="w"> </span><span class="nx">validation</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">flake</span><span class="p">.</span><span class="nx">nix</span><span class="w">          </span><span class="err">#</span><span class="w"> </span><span class="nx">Test</span><span class="w"> </span><span class="nx">environment</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">homely</span><span class="o">-</span><span class="nx">man</span><span class="p">.</span><span class="nx">nix</span><span class="w">         </span><span class="err">#</span><span class="w"> </span><span class="nx">Home</span><span class="w"> </span><span class="nx">Manager</span><span class="w"> </span><span class="nx">configuration</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">home</span><span class="o">/</span><span class="w">                  </span><span class="err">#</span><span class="w"> </span><span class="nx">Home</span><span class="w"> </span><span class="nx">Manager</span><span class="w"> </span><span class="nx">submodules</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="kd">base</span><span class="p">.</span><span class="nx">nix</span><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">Shells</span><span class="p">,</span><span class="w"> </span><span class="nx">git</span><span class="p">,</span><span class="w"> </span><span class="nx">xdg</span><span class="w"> </span><span class="nx">defaults</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">notifications</span><span class="p">.</span><span class="nx">nix</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="nx">Mako</span><span class="w"> </span><span class="nx">configuration</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">kitty</span><span class="p">.</span><span class="nx">nix</span><span class="w">           </span><span class="err">#</span><span class="w"> </span><span class="nx">Kitty</span><span class="w"> </span><span class="nx">settings</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">sway</span><span class="p">.</span><span class="nx">nix</span><span class="w">            </span><span class="err">#</span><span class="w"> </span><span class="nx">Sway</span><span class="w"> </span><span class="nx">WM</span><span class="w"> </span><span class="nx">config</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="nx">waybar</span><span class="p">.</span><span class="nx">nix</span><span class="w">          </span><span class="err">#</span><span class="w"> </span><span class="nx">Waybar</span><span class="w"> </span><span class="nx">config</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">style</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">scripts</span><span class="p">.</span><span class="nx">nix</span><span class="w">         </span><span class="err">#</span><span class="w"> </span><span class="nx">Sway</span><span class="o">/</span><span class="nx">Waybar</span><span class="w"> </span><span class="nx">helper</span><span class="w"> </span><span class="nx">scripts</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="nx">python</span><span class="o">-</span><span class="nx">dev</span><span class="p">.</span><span class="nx">nix</span><span class="w">         </span><span class="err">#</span><span class="w"> </span><span class="nx">Python</span><span class="w"> </span><span class="nx">development</span><span class="w"> </span><span class="nx">environment</span>
</code></pre></div>

<h2 id="building-specific-hosts">Building Specific Hosts</h2>
<p>The rebuild script automatically detects your environment:</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Auto-detect and build appropriate configuration</span>
./rebuild.sh

<span class="c1"># Manual override</span>
./rebuild.sh<span class="w"> </span>thinker<span class="w">      </span><span class="c1"># Force ThinkPad build</span>
./rebuild.sh<span class="w"> </span>1337book<span class="w">     </span><span class="c1"># Force HP Elitebook build</span>

<span class="c1"># Or use nixos-rebuild directly</span>
sudo<span class="w"> </span>nixos-rebuild<span class="w"> </span>switch<span class="w"> </span>--flake<span class="w"> </span>.#thinker
sudo<span class="w"> </span>nixos-rebuild<span class="w"> </span>switch<span class="w"> </span>--flake<span class="w"> </span>.#1337book
</code></pre></div>

<h3 id="auto-detection-logic">Auto-Detection Logic</h3>
<p>The script detects your environment using:
1. <strong>Hostname</strong> - Recognizes "Thinker", "1337book", or "elitebook"
2. <strong>Hardware</strong> - Looks for ThinkPad-specific indicators (<code>/proc/acpi/ibm/version</code>)
3. <strong>HP Hardware</strong> - Detects HP/Hewlett-Packard via <code>lspci</code> or <code>dmidecode</code>
4. <strong>Fallback</strong> - Defaults to "thinker"</p>
<h2 id="key-features">Key Features</h2>
<h3 id="shared-all-desktop-hosts">Shared (All Desktop Hosts)</h3>
<ul>
<li><strong>Development</strong>: Git, GitHub CLI, Docker, Python environment</li>
<li><strong>Tools</strong>: Fish shell, Neovim, essential CLI utilities</li>
<li><strong>Base System</strong>: Common NixOS configuration</li>
</ul>
<h3 id="intel-npu-openvino-1337book-focus">Intel NPU / OpenVINO (1337book focus)</h3>
<ul>
<li><strong>Reproducible Toolkit</strong>: <code>nix develop</code> now unpacks Intel OpenVINO 2024.6 with the Intel NPU plugin pre-configured.</li>
<li><strong>Environment Wiring</strong>: Shell hook exports <code>INTEL_OPENVINO_DIR</code>, <code>IE_PLUGINS_PATH</code>, <code>LD_LIBRARY_PATH</code>, <code>PKG_CONFIG_PATH</code>, <code>PYTHONPATH</code>, and <code>INTEL_NPU_DEVICE</code> for immediate use.</li>
<li><strong>Sanity Checks</strong>: Startup script runs <code>openvino.runtime.Core().available_devices</code> and aborts if the NPU is missing (use <code>CALNIX_SKIP_NPU_CHECK=1</code> to bypass on unsupported hosts/CI).</li>
<li><strong>Driver Helper</strong>: <code>intel-npu-driver-helper --install|--status|--uninstall</code> wraps Intel's <code>linux-npu-driver</code> repo so kernel modules stay in sync after updates.</li>
<li><strong>Extra Docs</strong>: See <code>docs/npu-support.md</code> for setup notes, verification steps, and troubleshooting tips.</li>
<li><strong>Scanner Runbook</strong>: See <code>docs/scanners/epson-ds510-linux.md</code> for DS-510 scan/recovery steps.</li>
<li><strong>System-Wide Runtime</strong>: On 1337book the OpenVINO 2024.6 runtime is installed globally; login shells automatically export the same variables as the dev shell so <code>python3 -c 'from openvino.runtime import Core'</code> works anywhere.</li>
</ul>
<h3 id="desktop-hosts-thinker-1337book">Desktop Hosts (Thinker &amp; 1337book)</h3>
<ul>
<li><strong>Gaming</strong>: Steam, Blender, Krita, Aseprite, Dwarf Fortress</li>
<li><strong>Desktop</strong>: Sway, Bluetooth, audio (PipeWire), power management</li>
<li><strong>Creative</strong>: Image editing, 3D modeling, digital art tools</li>
<li><strong>Media</strong>: VLC, FFmpeg for video processing</li>
</ul>
<h3 id="thinkpad-specific-thinker">ThinkPad Specific (Thinker)</h3>
<ul>
<li><strong>Power Management</strong>: ThinkPad-optimized TLP settings</li>
<li><strong>Hardware</strong>: ThinkPad ACPI integration</li>
</ul>
<h3 id="hp-elitebook-specific-1337book">HP Elitebook Specific (1337book)</h3>
<ul>
<li><strong>Power Management</strong>: HP-optimized TLP settings with thermal management</li>
<li><strong>Hardware</strong>: Latest kernel packages, HP firmware updates (fwupd)</li>
<li><strong>Battery</strong>: HP-specific charging thresholds (75%-85%)</li>
</ul>
<h2 id="development-workflow">Development Workflow</h2>
<ol>
<li><strong>Make Changes</strong> to configuration files</li>
<li><strong>Run Tests</strong> to validate changes:
   <code>bash
   ./tests/run_tests.sh --quick</code></li>
<li><strong>Deploy</strong> if tests pass:
   <code>bash
   ./rebuild.sh</code></li>
</ol>
<h2 id="customization">Customization</h2>
<h3 id="adding-packages">Adding Packages</h3>
<ul>
<li><strong>All hosts</strong>: Edit <code>modules/base.nix</code></li>
<li><strong>Desktop hosts only</strong>: Edit <code>modules/desktop.nix</code></li>
<li><strong>Gaming only</strong>: Edit <code>modules/gaming.nix</code></li>
<li><strong>ThinkPad only</strong>: Edit <code>hosts/thinker/configuration.nix</code></li>
<li><strong>HP Elitebook only</strong>: Edit <code>hosts/1337book/configuration.nix</code></li>
<li><strong>Home Manager</strong>: Edit <code>home/*.nix</code></li>
</ul>
<h3 id="creating-new-hosts">Creating New Hosts</h3>
<ol>
<li>Create <code>hosts/new-host/configuration.nix</code></li>
<li>Add to <code>flake.nix</code> nixosConfigurations</li>
<li>Update <code>rebuild.sh</code> with new host option</li>
<li>Add tests for new configuration</li>
</ol>
<h2 id="troubleshooting">Troubleshooting</h2>
<h3 id="desktop-hosts-thinker-1337book_1">Desktop Hosts (Thinker &amp; 1337book)</h3>
<ul>
<li>Pywal colors: Ensure wallpaper at <code>~/Pictures/background.jpg</code></li>
<li>Brightness controls: User must be in <code>video</code> group</li>
<li>Bluetooth: Use <code>Mod4+b</code> for GUI or <code>Mod4+Shift+b</code> for terminal</li>
</ul>
<h3 id="thinkpad-specific-thinker_1">ThinkPad-Specific (Thinker)</h3>
<ul>
<li>ACPI features: Check <code>/proc/acpi/ibm/</code> for available functions</li>
</ul>
<h3 id="hp-elitebook-specific-1337book_1">HP Elitebook-Specific (1337book)</h3>
<ul>
<li>Firmware updates: Use <code>fwupdmgr</code> for HP firmware management</li>
<li>Thermal management: <code>thermald</code> service handles temperature control</li>
</ul>
<h3 id="testing-issues">Testing Issues</h3>
<ul>
<li><strong>Nix not found</strong>: Install Nix or use <code>--quick</code> flag</li>
<li><strong>Permission errors</strong>: Ensure scripts are executable: <code>chmod +x tests/*.sh</code></li>
<li><strong>Python errors</strong>: Ensure Python 3 is available</li>
</ul>
<h2 id="legacy-support">Legacy Support</h2>
<p>The flake maintains backward compatibility with:
- <code>nixos</code> and <code>Thinker</code> configurations (both point to thinker host)</p>
  </article>
  <footer class="mt-5"><hr/><p class="small">Generated by scripts/build_pages.py</p></footer>
</div>
</body>
</html>
