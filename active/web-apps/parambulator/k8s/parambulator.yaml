apiVersion: v1
kind: Namespace
metadata:
  name: parambulator
---
apiVersion: v1
kind: Secret
metadata:
  name: parambulator-env
  namespace: parambulator
type: Opaque
stringData:
  SECRET_KEY: "replace-this-secret-key-before-public-use"
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: parambulator-data
  namespace: parambulator
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: parambulator
  namespace: parambulator
spec:
  replicas: 1
  selector:
    matchLabels:
      app: parambulator
  template:
    metadata:
      labels:
        app: parambulator
    spec:
      containers:
        - name: parambulator
          image: python:3.12-slim
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-ec"]
          args:
            - |
              APP_DIR=/tmp/megarepo-main/active/web-apps/parambulator

              fetch_remote_sha() {
                python - <<'PY'
              import json
              from urllib.request import Request, urlopen

              req = Request(
                  "https://api.github.com/repos/calvinloveland/megarepo/commits/main",
                  headers={
                      "Accept": "application/vnd.github+json",
                      "User-Agent": "parambulator-git-sync",
                  },
              )
              with urlopen(req, timeout=10) as response:
                  payload = json.load(response)
              print(payload.get("sha", ""))
              PY
              }

              install_app() {
                rm -rf /tmp/megarepo-main /tmp/megarepo-main.tar.gz
                python -c 'from urllib.request import urlretrieve; urlretrieve("https://github.com/calvinloveland/megarepo/archive/refs/heads/main.tar.gz", "/tmp/megarepo-main.tar.gz")'
                tar -xzf /tmp/megarepo-main.tar.gz -C /tmp
                mkdir -p /data/feedback/addressed /data/saves
                if [ ! -L "$APP_DIR/data" ]; then
                  rm -rf "$APP_DIR/data"
                  ln -s /data "$APP_DIR/data"
                fi
                cd "$APP_DIR"
                pip install --no-cache-dir "Flask>=2.3" "Flask-WTF>=1.1.1,<2.0" "gunicorn>=21.2,<22"
                pip install --no-cache-dir --no-deps -e .
              }

              CURRENT_SHA="$(fetch_remote_sha || true)"
              install_app
              printf '%s\n' "${CURRENT_SHA:-}" > /tmp/parambulator-source-sha

              cd "$APP_DIR"
              gunicorn -w 2 -b 0.0.0.0:5000 "parambulator.app:create_app()" &
              APP_PID=$!

              (
                while true; do
                  sleep "${GIT_SYNC_INTERVAL_SECONDS:-900}"
                  NEW_SHA="$(fetch_remote_sha || true)"
                  [ -z "$NEW_SHA" ] && continue
                  OLD_SHA="$(cat /tmp/parambulator-source-sha 2>/dev/null || true)"
                  [ "$NEW_SHA" = "$OLD_SHA" ] && continue
                  echo "New main commit detected ($OLD_SHA -> $NEW_SHA); restarting pod to refresh code."
                  kill "$APP_PID" >/dev/null 2>&1 || true
                  break
                done
              ) &

              wait "$APP_PID"
          env:
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: parambulator-env
                  key: SECRET_KEY
            - name: FLASK_DEBUG
              value: "false"
            - name: HOST
              value: "0.0.0.0"
            - name: PORT
              value: "5000"
            - name: APP_VERSION
              value: "release-20260222-git-sync"
            - name: GIT_SYNC_INTERVAL_SECONDS
              value: "900"
            - name: FEEDBACK_ADMIN_USERNAME
              valueFrom:
                secretKeyRef:
                  name: parambulator-feedback-auth
                  key: username
                  optional: true
            - name: FEEDBACK_ADMIN_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: parambulator-feedback-auth
                  key: password
                  optional: true
          ports:
            - name: http
              containerPort: 5000
          volumeMounts:
            - name: parambulator-data
              mountPath: /data
        - name: cloudflared
          image: cloudflare/cloudflared:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: TUNNEL_TOKEN
              valueFrom:
                secretKeyRef:
                  name: parambulator-cloudflared-token
                  key: token
          args:
            - tunnel
            - --no-autoupdate
            - run
            - --token
            - $(TUNNEL_TOKEN)
      volumes:
        - name: parambulator-data
          persistentVolumeClaim:
            claimName: parambulator-data
---
apiVersion: v1
kind: Service
metadata:
  name: parambulator
  namespace: parambulator
spec:
  selector:
    app: parambulator
  ports:
    - name: http
      port: 5000
      targetPort: http
