<!-- Interactive People Table -->
<div class="people-table space-y-4">
  <div class="flex items-center justify-between">
    <div>
      <label class="block text-sm font-semibold mb-1">People & Constraints</label>
      <p class="text-xs text-slate-500">Add people and configure their constraints</p>
    </div>
    <button
      type="button"
      onclick="addPersonRow()"
      class="rounded-md bg-indigo-600 px-3 py-1.5 text-xs font-semibold text-white shadow-sm hover:bg-indigo-700"
    >
      + Add Person
    </button>
  </div>

  <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
    <div class="flex items-center justify-between mb-3">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-600">Column Behavior & Constraints</p>
        <p class="text-xs text-slate-500">Adjust type and weighting for each constraint column below</p>
      </div>
      <button
        type="button"
        onclick="addCustomColumn()"
        class="text-xs font-semibold text-slate-600 px-2 py-1 rounded border border-slate-300 hover:bg-slate-100"
        title="Add an additional custom data column to the people table."
      >
        + Add Column
      </button>
    </div>
    <div class="grid grid-cols-2 gap-3 text-xs">
      <div class="space-y-1">
        <label class="font-semibold text-slate-600">Reading Level</label>
        <div class="flex gap-2">
          <select id="col-type-reading_level" class="w-full rounded border border-slate-300 px-2 py-1" onchange="updateColumnConfig()">
            <option value="mix">Mix</option>
            <option value="avoid">Avoid</option>
            <option value="group">Group</option>
            <option value="directional">Directional</option>
            <option value="ignore">Ignore</option>
          </select>
          <input id="col-weight-reading_level" type="number" step="0.05" min="0" max="1" class="w-20 rounded border border-slate-300 px-2 py-1" onchange="updateColumnConfig()" />
        </div>
      </div>
      <div class="space-y-1">
        <label class="font-semibold text-slate-600">Talkative</label>
        <div class="flex gap-2">
          <select id="col-type-talkative" class="w-full rounded border border-slate-300 px-2 py-1" onchange="updateColumnConfig()">
            <option value="avoid">Avoid</option>
            <option value="mix">Mix</option>
            <option value="group">Group</option>
            <option value="directional">Directional</option>
            <option value="ignore">Ignore</option>
          </select>
          <input id="col-weight-talkative" type="number" step="0.05" min="0" max="1" class="w-20 rounded border border-slate-300 px-2 py-1" onchange="updateColumnConfig()" />
        </div>
      </div>
      <div class="space-y-1">
        <label class="font-semibold text-slate-600">Front Priority</label>
        <div class="flex gap-2">
          <select id="col-type-iep_front" class="w-full rounded border border-slate-300 px-2 py-1" onchange="updateColumnConfig()">
            <option value="directional">Directional</option>
            <option value="avoid">Avoid</option>
            <option value="mix">Mix</option>
            <option value="group">Group</option>
            <option value="ignore">Ignore</option>
          </select>
          <input id="col-weight-iep_front" type="number" step="0.05" min="0" max="1" class="w-20 rounded border border-slate-300 px-2 py-1" onchange="updateColumnConfig()" />
        </div>
      </div>
      <div class="space-y-1">
        <label class="font-semibold text-slate-600">Avoid List</label>
        <div class="flex gap-2">
          <select id="col-type-avoid" class="w-full rounded border border-slate-300 px-2 py-1" onchange="updateColumnConfig()">
            <option value="avoid">Avoid</option>
            <option value="group">Group</option>
            <option value="mix">Mix</option>
            <option value="directional">Directional</option>
            <option value="ignore">Ignore</option>
          </select>
          <input id="col-weight-avoid" type="number" step="0.05" min="0" max="1" class="w-20 rounded border border-slate-300 px-2 py-1" onchange="updateColumnConfig()" />
        </div>
      </div>
    </div>
    <p class="mt-2 text-[11px] text-slate-500">
      <strong>Tip:</strong> Set type to "Ignore" and weight to 0 to disable a column. 
      These settings persist and affect scoring calculations.
    </p>
  </div>

  <div class="people-table-shell overflow-x-auto rounded-lg border border-slate-200 bg-white">
    <table id="people-table" class="w-full text-sm">
      <thead class="people-table-head bg-slate-50 border-b border-slate-200">
        <tr id="people-table-head-row">
          <th class="px-3 py-2 text-left font-semibold text-slate-700">Name</th>
          <th class="px-3 py-2 text-left font-semibold text-slate-700">Reading Level</th>
          <th class="px-3 py-2 text-left font-semibold text-slate-700">Talkative</th>
          <th class="px-3 py-2 text-left font-semibold text-slate-700">Front Priority</th>
          <th class="px-3 py-2 text-left font-semibold text-slate-700">Avoid (semicolon separated)</th>
          <th class="px-3 py-2 text-center font-semibold text-slate-700">Actions</th>
        </tr>
      </thead>
      <tbody id="people-table-body">
        <!-- Rows will be populated by JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Hidden textarea to maintain compatibility with backend -->
  <textarea
    name="people_table"
    id="people_table_hidden"
    class="hidden"
  >{{ people_table }}</textarea>
  <input type="hidden" id="additional_columns_hidden" value="[]" />
  <input type="hidden" name="column_config" id="column_config_hidden" value='{{ column_config | e }}' />
</div>

<script>
var BASE_COLUMNS = ['name', 'reading_level', 'talkative', 'iep_front', 'avoid'];
var additionalColumns = [];

function normalizeColumnKey(value) {
  return value.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_+|_+$/g, '');
}

function displayColumnLabel(columnKey) {
  if (columnKey === 'iep_front') return 'Front Priority';
  return columnKey
    .split('_')
    .filter(Boolean)
    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

function sanitizeValue(value) {
  return String(value ?? '')
    .replace(/&/g, '&amp;')
    .replace(/"/g, '&quot;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;');
}

function updateAdditionalColumnsInput() {
  const input = document.getElementById('additional_columns_hidden');
  if (input) {
    input.value = JSON.stringify(additionalColumns);
  }
}

function parsePeopleTable() {
  const textarea = document.getElementById('people_table_hidden');
  const text = textarea.value.trim();
  if (!text) {
    additionalColumns = [];
    updateAdditionalColumnsInput();
    return [];
  }

  const lines = text.split('\n').map(line => line.trim()).filter(Boolean);
  if (!lines.length) {
    additionalColumns = [];
    updateAdditionalColumnsInput();
    return [];
  }

  const delimiter = lines[0].includes('\t') ? '\t' : ',';
  const firstRow = lines[0].split(delimiter).map(part => part.trim());
  const firstCell = (firstRow[0] || '').toLowerCase();
  const hasHeader = firstCell === 'name' || firstCell === 'student';
  const headers = hasHeader ? firstRow.map(normalizeColumnKey) : [...BASE_COLUMNS];
  while (headers.length < firstRow.length) {
    headers.push(`custom_${headers.length + 1}`);
  }

  additionalColumns = headers
    .filter(column => column && !BASE_COLUMNS.includes(column))
    .map(column => ({ key: column, label: displayColumnLabel(column) }));
  updateAdditionalColumnsInput();

  const people = [];
  const dataLines = hasHeader ? lines.slice(1) : lines;
  for (const line of dataLines) {
    const parts = line.split(delimiter).map(part => part.trim());
    const row = {};
    headers.forEach((header, index) => {
      row[header] = parts[index] || '';
    });

    const name = row.name || '';
    if (!name) continue;

    const person = {
      name,
      reading_level: row.reading_level || 'medium',
      talkative: row.talkative || 'no',
      iep_front: row.iep_front || 'no',
      avoid: row.avoid || '',
      extra: {},
    };

    additionalColumns.forEach(column => {
      person.extra[column.key] = row[column.key] || '';
    });
    people.push(person);
  }

  return people;
}

function readColumnConfig() {
  const configInput = document.getElementById('column_config_hidden');
  try {
    return JSON.parse(configInput.value);
  } catch (error) {
    return {};
  }
}

function writeColumnConfig(config) {
  const configInput = document.getElementById('column_config_hidden');
  configInput.value = JSON.stringify(config);
}

function initializeColumnConfig() {
  const config = readColumnConfig();
  if (!config || Object.keys(config).length === 0) {
    return;
  }

  const columns = ['reading_level', 'talkative', 'iep_front', 'avoid'];
  columns.forEach(column => {
    const typeField = document.getElementById(`col-type-${column}`);
    const weightField = document.getElementById(`col-weight-${column}`);
    if (typeField && config[column]) {
      typeField.value = config[column].type || typeField.value;
    }
    if (weightField && config[column]) {
      weightField.value = config[column].weight ?? weightField.value;
    }
  });
}

function updateColumnConfig() {
  const config = readColumnConfig();
  const columns = ['reading_level', 'talkative', 'iep_front', 'avoid'];

  columns.forEach(column => {
    const typeField = document.getElementById(`col-type-${column}`);
    const weightField = document.getElementById(`col-weight-${column}`);
    if (!typeField || !weightField) return;

    const weightValue = parseFloat(weightField.value);
    config[column] = {
      type: typeField.value,
      weight: Number.isFinite(weightValue) ? weightValue : 0,
    };
  });

  writeColumnConfig(config);
}

function updateTableHeader() {
  const headerRow = document.getElementById('people-table-head-row');
  if (!headerRow) return;

  let headerHtml = `
    <th class="px-3 py-2 text-left font-semibold text-slate-700">Name</th>
    <th class="px-3 py-2 text-left font-semibold text-slate-700">Reading Level</th>
    <th class="px-3 py-2 text-left font-semibold text-slate-700">Talkative</th>
    <th class="px-3 py-2 text-left font-semibold text-slate-700">Front Priority</th>
    <th class="px-3 py-2 text-left font-semibold text-slate-700">Avoid (semicolon separated)</th>
  `;

  additionalColumns.forEach(column => {
    headerHtml += `<th class="px-3 py-2 text-left font-semibold text-slate-700">${sanitizeValue(column.label)}</th>`;
  });

  headerHtml += '<th class="px-3 py-2 text-center font-semibold text-slate-700">Actions</th>';
  headerRow.innerHTML = headerHtml;
}

function serializePeopleTable() {
  const tbody = document.getElementById('people-table-body');
  const rows = tbody.querySelectorAll('tr');
  const headers = [...BASE_COLUMNS, ...additionalColumns.map(column => column.key)];
  const lines = [headers.join(', ')];

  rows.forEach(row => {
    const name = row.querySelector('input[data-field="name"]').value.trim();
    if (!name) return; // Skip empty rows

    const reading_level = row.querySelector('select[data-field="reading_level"]').value;
    const talkative = row.querySelector('select[data-field="talkative"]').value;
    const iep_front = row.querySelector('select[data-field="iep_front"]').value;
    const avoid = row.querySelector('input[data-field="avoid"]').value.trim();

    const values = [name, reading_level, talkative, iep_front, avoid];
    additionalColumns.forEach(column => {
      const input = row.querySelector(`input[data-field="${column.key}"]`);
      values.push(input ? input.value.trim() : '');
    });

    lines.push(values.join(', '));
  });

  document.getElementById('people_table_hidden').value = lines.join('\n');
}

function createPersonRow(person) {
  const tr = document.createElement('tr');
  tr.className = 'border-b border-slate-100 hover:bg-slate-50';

  const extraCells = additionalColumns
    .map(
      column => `
    <td class="px-3 py-2">
      <input
        type="text"
        data-field="${sanitizeValue(column.key)}"
        value="${sanitizeValue((person.extra || {})[column.key] || '')}"
        class="w-full rounded border border-slate-300 px-2 py-1 text-sm"
        onchange="serializePeopleTable()"
      />
    </td>`
    )
    .join('');

  tr.innerHTML = `
    <td class="px-3 py-2">
      <input
        type="text"
        data-field="name"
        value="${sanitizeValue(person.name)}"
        placeholder="Name"
        class="w-full rounded border border-slate-300 px-2 py-1 text-sm"
        onchange="serializePeopleTable()"
      />
    </td>
    <td class="px-3 py-2">
      <select
        data-field="reading_level"
        class="w-full rounded border border-slate-300 px-2 py-1 text-sm"
        onchange="serializePeopleTable()"
      >
        <option value="low" ${person.reading_level === 'low' ? 'selected' : ''}>Low</option>
        <option value="medium" ${person.reading_level === 'medium' ? 'selected' : ''}>Medium</option>
        <option value="high" ${person.reading_level === 'high' ? 'selected' : ''}>High</option>
      </select>
    </td>
    <td class="px-3 py-2">
      <select
        data-field="talkative"
        class="w-full rounded border border-slate-300 px-2 py-1 text-sm"
        onchange="serializePeopleTable()"
      >
        <option value="no" ${person.talkative === 'no' ? 'selected' : ''}>No</option>
        <option value="yes" ${person.talkative === 'yes' ? 'selected' : ''}>Yes</option>
      </select>
    </td>
    <td class="px-3 py-2">
      <select
        data-field="iep_front"
        class="w-full rounded border border-slate-300 px-2 py-1 text-sm"
        onchange="serializePeopleTable()"
      >
        <option value="no" ${person.iep_front === 'no' ? 'selected' : ''}>No</option>
        <option value="yes" ${person.iep_front === 'yes' ? 'selected' : ''}>Yes</option>
      </select>
    </td>
    <td class="px-3 py-2">
      <input
        type="text"
        data-field="avoid"
        value="${sanitizeValue(person.avoid)}"
        placeholder="Names separated by ;"
        class="w-full rounded border border-slate-300 px-2 py-1 text-sm"
        onchange="serializePeopleTable()"
      />
    </td>
    ${extraCells}
    <td class="px-3 py-2 text-center">
      <button
        type="button"
        onclick="deletePersonRow(this)"
        class="text-red-600 hover:text-red-800 text-xs font-semibold"
        title="Delete"
      >
        Delete
      </button>
    </td>
  `;
  
  return tr;
}

function addPersonRow() {
  const tbody = document.getElementById('people-table-body');
  const newPerson = {
    name: '',
    reading_level: 'medium',
    talkative: 'no',
    iep_front: 'no',
    avoid: '',
    extra: Object.fromEntries(additionalColumns.map(column => [column.key, ''])),
  };
  const row = createPersonRow(newPerson);
  tbody.appendChild(row);
  
  // Focus the name input
  row.querySelector('input[data-field="name"]').focus();
}

function deletePersonRow(button) {
  const row = button.closest('tr');
  row.remove();
  serializePeopleTable();
}

function collectPeopleFromTable() {
  const rows = document.querySelectorAll('#people-table-body tr');
  const people = [];

  rows.forEach(row => {
    const name = row.querySelector('input[data-field="name"]')?.value.trim() || '';
    if (!name) return;
    const person = {
      name,
      reading_level: row.querySelector('select[data-field="reading_level"]')?.value || 'medium',
      talkative: row.querySelector('select[data-field="talkative"]')?.value || 'no',
      iep_front: row.querySelector('select[data-field="iep_front"]')?.value || 'no',
      avoid: row.querySelector('input[data-field="avoid"]')?.value.trim() || '',
      extra: {},
    };
    additionalColumns.forEach(column => {
      const input = row.querySelector(`input[data-field="${column.key}"]`);
      person.extra[column.key] = input ? input.value.trim() : '';
    });
    people.push(person);
  });

  return people;
}

function addCustomColumn() {
  const label = window.prompt('New column name (for example: support_level)');
  if (!label) return;

  let key = normalizeColumnKey(label);
  if (!key) key = `custom_${additionalColumns.length + 1}`;
  if (BASE_COLUMNS.includes(key)) {
    key = `${key}_extra`;
  }

  const existing = new Set(additionalColumns.map(column => column.key));
  let suffix = 1;
  const baseKey = key;
  while (existing.has(key) || BASE_COLUMNS.includes(key)) {
    key = `${baseKey}_${suffix}`;
    suffix += 1;
  }

  const currentPeople = collectPeopleFromTable();
  additionalColumns.push({ key, label: label.trim() });
  updateAdditionalColumnsInput();
  updateTableHeader();

  currentPeople.forEach(person => {
    person.extra = person.extra || {};
    person.extra[key] = '';
  });
  renderPeopleTable(currentPeople);
}

function renderPeopleTable(people) {
  const tbody = document.getElementById('people-table-body');
  tbody.innerHTML = '';
  updateTableHeader();

  if (!people.length) {
    for (let i = 0; i < 3; i += 1) {
      addPersonRow();
    }
  } else {
    people.forEach(person => {
      const row = createPersonRow(person);
      tbody.appendChild(row);
    });
  }

  serializePeopleTable();
}

function initializePeopleTable() {
  const people = parsePeopleTable();
  renderPeopleTable(people);
  initializeColumnConfig();
  updateColumnConfig();
}

// Initialize when the tab content loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializePeopleTable);
} else {
  initializePeopleTable();
}
</script>
