<form id="controls-form" class="space-y-4">
  <input type="hidden" name="chart_json" value="{{ chart_json }}" />
  <input type="hidden" name="people_json" value="{{ people_json }}" />
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

  <div>
    <label class="block text-sm font-semibold text-slate-700">People (spreadsheet style)</label>
    <p class="text-xs text-slate-500">Columns: name, reading_level (low/medium/high), talkative (yes/no), iep_front (yes/no), avoid (semicolon list)</p>
    <textarea
      name="people_table"
      rows="10"
      class="mt-2 w-full rounded-lg border border-slate-300 bg-white p-3 font-mono text-xs text-slate-800 shadow-sm"
    >{{ people_table }}</textarea>
    <button
      type="button"
      onclick="document.querySelector('[name=people_table]').value=''; document.querySelector('[name=people_json]').value=''"
      class="mt-2 rounded-md border border-slate-300 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50"
    >
      Clear All People
    </button>
  </div>

  <!-- Grid configuration (rows/cols/iterations) - hidden inputs used by layout editor, configured when editing layout below -->
  <input type="hidden" name="rows" min="1" value="{{ rows }}" />
  <input type="hidden" name="cols" min="1" value="{{ cols }}" />
  <input type="hidden" name="iterations" min="1" value="200" />

  <div>
    <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">Design</label>
    <div class="mt-2 flex flex-wrap gap-2">
      {% for option in available_designs %}
      <button
        type="button"
        name="design"
        value="{{ option }}"
        class="rounded-full border px-3 py-1 text-xs font-semibold shadow-sm {% if option == design %}border-indigo-500 bg-indigo-100 text-indigo-700{% else %}border-slate-300 bg-white text-slate-600{% endif %}"
        hx-post="/design"
        hx-target="#app"
        hx-include="#controls-form"
      >
        {{ option|replace('_', ' ') }}
      </button>
      {% endfor %}
    </div>
  </div>

  <div>
    <label class="block text-sm font-semibold text-slate-700">Seat layout</label>
    <p class="text-xs text-slate-500">Click to toggle seats. Use expand and duplicate buttons to modify grid.</p>
    
    <!-- Grid controls -->
    <div class="mt-2 flex flex-wrap gap-2">
      <button
        type="button"
        onclick="expandLayout(this.form, 'up')"
        class="rounded-md bg-blue-500 px-3 py-1 text-xs font-semibold text-white shadow hover:bg-blue-600"
      >
        ▲ Expand Up
      </button>
      <button
        type="button"
        onclick="expandLayout(this.form, 'down')"
        class="rounded-md bg-blue-500 px-3 py-1 text-xs font-semibold text-white shadow hover:bg-blue-600"
      >
        ▼ Expand Down
      </button>
      <button
        type="button"
        onclick="expandLayout(this.form, 'left')"
        class="rounded-md bg-blue-500 px-3 py-1 text-xs font-semibold text-white shadow hover:bg-blue-600"
      >
        ◄ Expand Left
      </button>
      <button
        type="button"
        onclick="expandLayout(this.form, 'right')"
        class="rounded-md bg-blue-500 px-3 py-1 text-xs font-semibold text-white shadow hover:bg-blue-600"
      >
        ► Expand Right
      </button>
      <button
        type="button"
        onclick="duplicateLayout(this.form, 'row')"
        class="rounded-md bg-purple-500 px-3 py-1 text-xs font-semibold text-white shadow hover:bg-purple-600"
      >
        ⊞ Duplicate Row
      </button>
      <button
        type="button"
        onclick="duplicateLayout(this.form, 'col')"
        class="rounded-md bg-purple-500 px-3 py-1 text-xs font-semibold text-white shadow hover:bg-purple-600"
      >
        ⊞ Duplicate Col
      </button>
    </div>

    <!-- Layout grid with toggle buttons -->
    <div class="mt-3 overflow-auto rounded-lg border border-slate-200 bg-white p-3">
      <table class="w-full border-collapse text-center">
        {% for row in layout_grid %}
        {% set row_index = loop.index0 %}
        <tr>
          {% for seat in row %}
          {% set col_index = loop.index0 %}
          <td class="border border-slate-200 p-1">
            <button
              type="button"
              name="layout_cell_{{ row_index }}_{{ col_index }}"
              value="1"
              onclick="toggleCell(this)"
              class="layout-cell h-8 w-8 rounded-md font-semibold transition-colors {% if seat %}bg-green-500 text-white{% else %}bg-slate-200 text-slate-400{% endif %}"
            >
              {% if seat %}✓{% else %}·{% endif %}
            </button>
            <input
              type="hidden"
              name="layout_cell_{{ row_index }}_{{ col_index }}_value"
              value="{% if seat %}1{% else %}0{% endif %}"
            />
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </table>
    </div>
  </div>

  <script>
  function toggleCell(btn) {
    event.preventDefault();
    const hiddenInput = btn.nextElementSibling;
    const isActive = btn.classList.contains('bg-green-500');
    
    if (isActive) {
      btn.classList.remove('bg-green-500', 'text-white');
      btn.classList.add('bg-slate-200', 'text-slate-400');
      btn.textContent = '·';
      hiddenInput.value = '0';
    } else {
      btn.classList.remove('bg-slate-200', 'text-slate-400');
      btn.classList.add('bg-green-500', 'text-white');
      btn.textContent = '✓';
      hiddenInput.value = '1';
    }
  }

  function expandLayout(form, direction) {
    event.preventDefault();
    // Collect current layout
    const cells = {};
    let maxRow = 0, maxCol = 0;
    
    Array.from(form.querySelectorAll('input[name^="layout_cell_"]')).forEach(input => {
      if (input.name.endsWith('_value')) {
        const match = input.name.match(/layout_cell_(\d+)_(\d+)_value/);
        if (match) {
          const r = parseInt(match[1]), c = parseInt(match[2]);
          maxRow = Math.max(maxRow, r);
          maxCol = Math.max(maxCol, c);
          cells[`${r},${c}`] = input.value === '1';
        }
      }
    });

    // Expand grid based on direction
    const newCells = {};
    let newMaxRow = maxRow, newMaxCol = maxCol;

    if (direction === 'up') {
      Object.entries(cells).forEach(([pos, val]) => {
        const [r, c] = pos.split(',').map(Number);
        newCells[`${r+1},${c}`] = val;
      });
      newMaxRow = maxRow + 1;
      // Add empty top row
      for (let c = 0; c <= maxCol; c++) newCells[`0,${c}`] = false;
    } else if (direction === 'down') {
      Object.entries(cells).forEach(([pos, val]) => newCells[pos] = val);
      // Add empty bottom row
      for (let c = 0; c <= maxCol; c++) newCells[`${maxRow+1},${c}`] = false;
      newMaxRow = maxRow + 1;
    } else if (direction === 'left') {
      Object.entries(cells).forEach(([pos, val]) => {
        const [r, c] = pos.split(',').map(Number);
        newCells[`${r},${c+1}`] = val;
      });
      newMaxCol = maxCol + 1;
      // Add empty left column
      for (let r = 0; r <= maxRow; r++) newCells[`${r},0`] = false;
    } else if (direction === 'right') {
      Object.entries(cells).forEach(([pos, val]) => newCells[pos] = val);
      // Add empty right column
      for (let r = 0; r <= maxRow; r++) newCells[`${r},${maxCol+1}`] = false;
      newMaxCol = maxCol + 1;
    }

    updateLayout(form, newCells, newMaxRow, newMaxCol);
  }

  function duplicateLayout(form, type) {
    event.preventDefault();
    const cells = {};
    let maxRow = 0, maxCol = 0;
    
    Array.from(form.querySelectorAll('input[name^="layout_cell_"]')).forEach(input => {
      if (input.name.endsWith('_value')) {
        const match = input.name.match(/layout_cell_(\d+)_(\d+)_value/);
        if (match) {
          const r = parseInt(match[1]), c = parseInt(match[2]);
          maxRow = Math.max(maxRow, r);
          maxCol = Math.max(maxCol, c);
          cells[`${r},${c}`] = input.value === '1';
        }
      }
    });

    const newCells = {};
    Object.entries(cells).forEach(([pos, val]) => newCells[pos] = val);

    if (type === 'row') {
      // Duplicate the last row
      for (let c = 0; c <= maxCol; c++) {
        newCells[`${maxRow+1},${c}`] = cells[`${maxRow},${c}`] || false;
      }
      maxRow = maxRow + 1;
    } else if (type === 'col') {
      // Duplicate the last column
      for (let r = 0; r <= maxRow; r++) {
        newCells[`${r},${maxCol+1}`] = cells[`${r},${maxCol}`] || false;
      }
      maxCol = maxCol + 1;
    }

    updateLayout(form, newCells, maxRow, maxCol);
  }

  function updateLayout(form, cells, maxRow, maxCol) {
    // Build new layout grid HTML
    let html = '<table class="w-full border-collapse text-center"><tbody>';
    for (let r = 0; r <= maxRow; r++) {
      html += '<tr>';
      for (let c = 0; c <= maxCol; c++) {
        const val = cells[`${r},${c}`] || false;
        html += `
          <td class="border border-slate-200 p-1">
            <button
              type="button"
              name="layout_cell_${r}_${c}"
              value="1"
              onclick="toggleCell(this)"
              class="layout-cell h-8 w-8 rounded-md font-semibold transition-colors ${val ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-400'}"
            >
              ${val ? '✓' : '·'}
            </button>
            <input
              type="hidden"
              name="layout_cell_${r}_${c}_value"
              value="${val ? '1' : '0'}"
            />
          </td>
        `;
      }
      html += '</tr>';
    }
    html += '</tbody></table>';

    // Replace old grid
    const oldTable = form.querySelector('div.mt-3 > table');
    oldTable.parentElement.innerHTML = html;

    // Update rows/cols inputs
    const rowsInput = form.querySelector('input[name="rows"]');
    const colsInput = form.querySelector('input[name="cols"]');
    if (rowsInput) rowsInput.value = maxRow + 1;
    if (colsInput) colsInput.value = maxCol + 1;
  }
  </script>

  <div class="flex flex-wrap gap-2">
    <button
      type="button"
      class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow"
      hx-post="/generate"
      hx-target="#app"
      hx-include="#controls-form"
    >
      Generate chart
    </button>
    <button
      type="button"
      class="rounded-md bg-slate-800 px-4 py-2 text-sm font-semibold text-white shadow"
      hx-post="/design"
      hx-target="#app"
      hx-include="#controls-form"
    >
      Re-score
    </button>
  </div>

  <div class="rounded-lg border border-slate-200 bg-slate-50 p-3">
    <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500">Save current chart</label>
    <div class="mt-2 flex gap-2">
      <input
        type="text"
        name="save_name"
        placeholder="e.g. period-1-jan"
        class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
      />
      <button
        type="button"
        class="rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow"
        hx-post="/save"
        hx-target="#app"
        hx-include="#controls-form"
      >
        Save
      </button>
    </div>
    <div class="mt-3">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Load saved charts</p>
      <div class="mt-2 flex flex-wrap gap-2">
        {% if saves %}
          {% for name in saves %}
          <button
            type="button"
            class="rounded-md border border-slate-300 bg-white px-3 py-1 text-xs font-semibold text-slate-700 shadow-sm"
            hx-get="/load?name={{ name }}"
            hx-target="#app"
          >
            {{ name }}
          </button>
          {% endfor %}
        {% else %}
          <span class="text-xs text-slate-500">No saved charts yet.</span>
        {% endif %}
      </div>
    </div>
  </div>

  {% if message %}
    <div class="rounded-md border border-indigo-200 bg-indigo-50 px-3 py-2 text-sm text-indigo-700">
      {{ message }}
    </div>
  {% endif %}

  {% if warnings %}
    <ul class="rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-700">
      {% for warning in warnings %}
      <li>⚠ {{ warning }}</li>
      {% endfor %}
    </ul>
  {% endif %}
</form>
