<div class="fixed bottom-6 left-6 z-40 flex gap-2">
  <button
    id="undo-btn"
    type="button"
    onclick="performUndo()"
    title="Undo (Ctrl+Z)"
    class="rounded-md border border-slate-300 bg-white/95 px-3 py-2 text-sm font-medium text-slate-700 shadow-md backdrop-blur hover:bg-slate-50 disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed"
    disabled
  >
    ↶ Undo
  </button>
  <button
    id="redo-btn"
    type="button"
    onclick="performRedo()"
    title="Redo (Ctrl+Shift+Z)"
    class="rounded-md border border-slate-300 bg-white/95 px-3 py-2 text-sm font-medium text-slate-700 shadow-md backdrop-blur hover:bg-slate-50 disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed"
    disabled
  >
    ↷ Redo
  </button>
</div>

<div class="tabs-bar flex gap-2 border-b border-slate-200 overflow-x-auto">
  <button
    type="button"
    class="tabs-trigger px-4 py-3 text-sm font-medium transition-colors whitespace-nowrap"
    data-tab="people"
    onclick="switchTab(event, 'people')"
  >
    People & Constraints
  </button>
  <button
    type="button"
    class="tabs-trigger px-4 py-3 text-sm font-medium transition-colors whitespace-nowrap"
    data-tab="layout"
    onclick="switchTab(event, 'layout')"
  >
    Seat Layout
  </button>
  <button
    type="button"
    class="tabs-trigger px-4 py-3 text-sm font-medium transition-colors whitespace-nowrap"
    data-tab="chart"
    onclick="switchTab(event, 'chart')"
  >
    Seating Chart
  </button>
  <button
    type="button"
    class="tabs-trigger px-4 py-3 text-sm font-medium transition-colors whitespace-nowrap"
    data-tab="score"
    onclick="switchTab(event, 'score')"
  >
    Scoring & Save
  </button>
</div>

<!-- Hidden form inputs for data persistence -->
<input type="hidden" name="chart_json" value="{{ chart_json }}" />
<input type="hidden" name="people_json" value="{{ people_json }}" />
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
<input type="hidden" name="rows" min="1" value="{{ rows }}" />
<input type="hidden" name="cols" min="1" value="{{ cols }}" />
<input type="hidden" name="iterations" min="1" value="200" />

<div id="tab-people" class="tabs-content tabs-panel py-6 px-4">
  <div class="space-y-4">
    {% include "partials/_people_table.html" %}
  </div>
</div>

<div id="tab-layout" class="tabs-content tabs-panel py-6 px-4 hidden">
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-semibold mb-2">Seat layout</label>
      <p class="text-xs text-slate-500 mb-3">Click seats to toggle availability. Use tools below to add/remove rows/columns.</p>
    </div>
    
    <!-- Grid control toolbar -->
    <div class="flex flex-wrap gap-2 items-center p-3 rounded-lg border border-slate-200 bg-slate-50">
      <div class="flex gap-1">
        <button type="button" onclick="addRowTop()" class="px-3 py-1.5 text-xs font-semibold rounded bg-blue-100 hover:bg-blue-200 text-blue-700" title="Add row at top">
          ↑ Add Row Top
        </button>
        <button type="button" onclick="addRowBottom()" class="px-3 py-1.5 text-xs font-semibold rounded bg-blue-100 hover:bg-blue-200 text-blue-700" title="Add row at bottom">
          ↓ Add Row Bottom
        </button>
      </div>
      <div class="flex gap-1">
        <button type="button" onclick="addColumnLeft()" class="px-3 py-1.5 text-xs font-semibold rounded bg-green-100 hover:bg-green-200 text-green-700" title="Add column on left">
          ← Add Col Left
        </button>
        <button type="button" onclick="addColumnRight()" class="px-3 py-1.5 text-xs font-semibold rounded bg-green-100 hover:bg-green-200 text-green-700" title="Add column on right">
          → Add Col Right
        </button>
      </div>
      <div class="flex gap-1">
        <button type="button" onclick="removeLastRow()" class="px-3 py-1.5 text-xs font-semibold rounded bg-red-100 hover:bg-red-200 text-red-700" title="Remove last row">
          Remove Row
        </button>
        <button type="button" onclick="removeLastColumn()" class="px-3 py-1.5 text-xs font-semibold rounded bg-red-100 hover:bg-red-200 text-red-700" title="Remove last column">
          Remove Col
        </button>
      </div>
      <button type="button" onclick="clearAllSeats()" class="px-3 py-1.5 text-xs font-semibold rounded bg-slate-200 hover:bg-slate-300 text-slate-700" title="Clear all seats">
        Clear All
      </button>
      <button type="button" onclick="fillAllSeats()" class="px-3 py-1.5 text-xs font-semibold rounded bg-slate-200 hover:bg-slate-300 text-slate-700" title="Fill all seats">
        Fill All
      </button>
    </div>
    
    <!-- Visual grid editor with button-style seats -->
    <div id="layout-grid-container" class="tabs-layout-grid overflow-auto rounded-lg border border-slate-200 bg-slate-100 p-3">
      <div id="layout-grid-visual" class="inline-block bg-white p-2 rounded">
        <!-- Grid will be rendered by JavaScript -->
      </div>
    </div>
    
    <!-- Advanced: text map editor (collapsed by default) -->
    <details class="rounded-lg border border-slate-200 bg-slate-50">
      <summary class="px-3 py-2 cursor-pointer text-xs font-semibold text-slate-600 hover:bg-slate-100">
        Advanced: Text Layout Editor
      </summary>
      <div class="p-3">
        <p class="text-xs text-slate-500 mb-2">Paste a layout map (X = seat, . = empty). Changes will sync with the visual grid.</p>
        <textarea
          id="layout_map_input"
          name="layout_map"
          rows="6"
          onchange="parseLayoutMapToGrid()"
          class="w-full rounded-lg border border-slate-300 bg-white p-3 font-mono text-xs text-slate-800 shadow-sm"
          placeholder="X...X&#10;X...X&#10;XXXXX"
        >{{ layout_map }}</textarea>
      </div>
    </details>
  </div>
</div>

<script>
// Layout grid state
let layoutGrid = [];

// Initialize layout grid from the server data
function initializeLayoutGrid() {
  const layoutMapInput = document.getElementById('layout_map_input');
  const mapText = layoutMapInput.value.trim();
  
  if (mapText) {
    parseLayoutMapToGrid();
  } else {
    // Default 4x5 grid
    layoutGrid = Array(4).fill(null).map(() => Array(5).fill(true));
    renderLayoutGrid();
  }
}

// Parse layout map text to grid
function parseLayoutMapToGrid() {
  const layoutMapInput = document.getElementById('layout_map_input');
  const mapText = layoutMapInput.value.trim();
  
  if (!mapText) {
    layoutGrid = Array(4).fill(null).map(() => Array(5).fill(true));
    renderLayoutGrid();
    return;
  }
  
  const lines = mapText.split('\n').filter(l => l.trim());
  layoutGrid = lines.map(line => 
    line.split('').map(char => char === 'X' || char === 'x')
  );
  
  renderLayoutGrid();
}

// Serialize grid to layout map text
function serializeGridToLayoutMap() {
  const mapText = layoutGrid.map(row => 
    row.map(seat => seat ? 'X' : '.').join('')
  ).join('\n');
  
  document.getElementById('layout_map_input').value = mapText;
}

// Render the visual button grid
function renderLayoutGrid() {
  const container = document.getElementById('layout-grid-visual');
  container.innerHTML = '';
  
  const table = document.createElement('div');
  table.style.display = 'inline-block';
  
  layoutGrid.forEach((row, rowIdx) => {
    const rowDiv = document.createElement('div');
    rowDiv.style.display = 'flex';
    rowDiv.style.gap = '2px';
    rowDiv.style.marginBottom = '2px';
    
    row.forEach((seat, colIdx) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = seat 
        ? 'w-10 h-10 rounded border-2 border-emerald-500 bg-emerald-100 hover:bg-emerald-200 text-emerald-700 font-bold text-xs'
        : 'w-10 h-10 rounded border-2 border-slate-300 bg-slate-50 hover:bg-slate-100 text-slate-400 text-xs';
      btn.textContent = seat ? '✓' : '✗';
      btn.title = seat ? 'Click to remove seat' : 'Click to add seat';
      btn.onclick = () => toggleSeat(rowIdx, colIdx);
      
      rowDiv.appendChild(btn);
    });
    
    table.appendChild(rowDiv);
  });
  
  container.appendChild(table);
  serializeGridToLayoutMap();
  updateRowColInputs();
}

// Toggle a seat
function toggleSeat(row, col) {
  layoutGrid[row][col] = !layoutGrid[row][col];
  renderLayoutGrid();
}

// Add row at top
function addRowTop() {
  const cols = layoutGrid[0]?.length || 5;
  layoutGrid.unshift(Array(cols).fill(true));
  renderLayoutGrid();
}

// Add row at bottom
function addRowBottom() {
  const cols = layoutGrid[0]?.length || 5;
  layoutGrid.push(Array(cols).fill(true));
  renderLayoutGrid();
}

// Add column on left
function addColumnLeft() {
  layoutGrid.forEach(row => row.unshift(true));
  renderLayoutGrid();
}

// Add column on right
function addColumnRight() {
  layoutGrid.forEach(row => row.push(true));
  renderLayoutGrid();
}

// Remove last row
function removeLastRow() {
  if (layoutGrid.length > 1) {
    layoutGrid.pop();
    renderLayoutGrid();
  }
}

// Remove last column
function removeLastColumn() {
  if (layoutGrid[0] && layoutGrid[0].length > 1) {
    layoutGrid.forEach(row => row.pop());
    renderLayoutGrid();
  }
}

// Clear all seats
function clearAllSeats() {
  layoutGrid = layoutGrid.map(row => row.map(() => false));
  renderLayoutGrid();
}

// Fill all seats
function fillAllSeats() {
  layoutGrid = layoutGrid.map(row => row.map(() => true));
  renderLayoutGrid();
}

// Update the rows/cols input fields
function updateRowColInputs() {
  const rowsInput = document.querySelector('input[name="rows"]');
  const colsInput = document.querySelector('input[name="cols"]');
  
  if (rowsInput) rowsInput.value = layoutGrid.length;
  if (colsInput) colsInput.value = layoutGrid[0]?.length || 0;
}

// Initialize on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeLayoutGrid);
} else {
  initializeLayoutGrid();
}
</script>

<div id="tab-chart" class="tabs-content tabs-panel py-6 px-4 hidden">
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-semibold mb-3">Current seating arrangement:</label>
    </div>
    {% include "partials/_chart.html" %}
  </div>
</div>

<div id="tab-score" class="tabs-content tabs-panel py-6 px-4 hidden">
  <div class="space-y-6">
    <div>
      <label class="block text-sm font-semibold mb-3">Chart fitness metrics:</label>
      {% include "partials/_score.html" %}
    </div>
    <div class="tabs-save-panel rounded-lg border border-slate-200 bg-slate-50 p-4">
      <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500 mb-3">Save current chart</label>
      <div class="flex gap-2 mb-4">
        <input
          type="text"
          name="save_name"
          placeholder="e.g. period-1-jan"
          class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
        />
        <button
          type="button"
          class="rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow"
          hx-post="/save"
          hx-target="#app"
          hx-include="#controls-form"
        >
          Save
        </button>
      </div>
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 mb-3">Load saved charts</p>
        <div class="flex flex-wrap gap-2">
          {% if saves %}
            {% for name in saves %}
            <button
              type="button"
              class="rounded-md border border-slate-300 bg-white px-3 py-1 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50"
              hx-get="/load?name={{ name }}"
              hx-target="#app"
            >
              {{ name }}
            </button>
            {% endfor %}
          {% else %}
            <span class="text-xs text-slate-500">No saved charts yet.</span>
          {% endif %}
        </div>
      </div>
    </div>

    {% if message %}
      <div class="rounded-md border border-indigo-200 bg-indigo-50 px-3 py-2 text-sm text-indigo-700">
        {{ message }}
      </div>
    {% endif %}

    {% if warnings %}
      <ul class="rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-700">
        {% for warning in warnings %}
        <li>⚠ {{ warning }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
</div>

<script>
function switchTab(event, tabName) {
  event.preventDefault();
  const tabs = document.querySelectorAll('.tabs-content');
  const buttons = document.querySelectorAll('.tabs-trigger');

  tabs.forEach(tab => tab.classList.add('hidden'));
  buttons.forEach(btn => {
    btn.classList.remove('border-b-2', 'border-indigo-600', 'text-indigo-600');
    btn.classList.add('text-slate-600', 'hover:text-slate-900');
  });

  document.getElementById('tab-' + tabName).classList.remove('hidden');
  event.target.classList.add('border-b-2', 'border-indigo-600', 'text-indigo-600');
  event.target.classList.remove('text-slate-600', 'hover:text-slate-900');
  try {
    sessionStorage.setItem('parambulatorActiveTab', tabName);
  } catch (error) {
    // Ignore storage errors.
  }
}

function initializeTabs() {
  let preferredTab = 'people';
  try {
    const savedTab = sessionStorage.getItem('parambulatorActiveTab');
    if (savedTab) {
      preferredTab = savedTab;
    }
  } catch (error) {
    preferredTab = 'people';
  }

  const preferredButton = document.querySelector(`.tabs-trigger[data-tab="${preferredTab}"]`);
  const fallbackButton = document.querySelector('.tabs-trigger[data-tab="people"]');
  const activeButton = preferredButton || fallbackButton;
  const activeTab = preferredButton ? preferredTab : 'people';
  if (activeButton) {
    switchTab({ preventDefault: () => {}, target: activeButton }, activeTab);
  }
}

initializeTabs();

if (!window.__parambulatorTabsAfterSwapBound) {
  document.body.addEventListener('htmx:afterSwap', function(event) {
    if (event.target && event.target.id === 'app' && typeof initializeTabs === 'function') {
      initializeTabs();
    }
  });
  window.__parambulatorTabsAfterSwapBound = true;
}
</script>
