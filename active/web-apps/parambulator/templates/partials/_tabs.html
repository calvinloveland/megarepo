<div class="tabs-bar flex gap-2 border-b border-slate-200 overflow-x-auto">
  <button
    type="button"
    class="tabs-trigger px-4 py-3 text-sm font-medium transition-colors whitespace-nowrap"
    data-tab="people"
    onclick="switchTab(event, 'people')"
  >
    People & Constraints
  </button>
  <button
    type="button"
    class="tabs-trigger px-4 py-3 text-sm font-medium transition-colors whitespace-nowrap"
    data-tab="layout"
    onclick="switchTab(event, 'layout')"
  >
    Seat Layout
  </button>
  <button
    type="button"
    class="tabs-trigger px-4 py-3 text-sm font-medium transition-colors whitespace-nowrap"
    data-tab="chart"
    onclick="switchTab(event, 'chart')"
  >
    Seating Chart
  </button>
  <button
    type="button"
    class="tabs-trigger px-4 py-3 text-sm font-medium transition-colors whitespace-nowrap"
    data-tab="score"
    onclick="switchTab(event, 'score')"
  >
    Scoring & Save
  </button>
</div>

<!-- Hidden form inputs for data persistence -->
<input type="hidden" name="chart_json" value="{{ chart_json }}" />
<input type="hidden" name="people_json" value="{{ people_json }}" />
<input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

<div id="tab-people" class="tabs-content tabs-panel py-6 px-4">
  <div class="space-y-4">
    {% include "partials/_people_table.html" %}
    <div class="tabs-input-grid grid grid-cols-3 gap-3">
      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500 mb-1">Rows</label>
        <input
          type="number"
          name="rows"
          min="1"
          value="{{ rows }}"
          class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
        />
      </div>
      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500 mb-1">Columns</label>
        <input
          type="number"
          name="cols"
          min="1"
          value="{{ cols }}"
          class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
        />
      </div>
      <div>
        <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500 mb-1">Iterations</label>
        <input
          type="number"
          name="iterations"
          min="1"
          value="200"
          class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
        />
      </div>
    </div>
  </div>
</div>

<div id="tab-layout" class="tabs-content tabs-panel py-6 px-4 hidden">
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-semibold mb-2">Seat layout</label>
      <p class="text-xs text-slate-500 mb-3">Toggle seats or paste a layout map (X = seat, . = empty).</p>
    </div>
    <div class="tabs-layout-grid overflow-auto rounded-lg border border-slate-200 bg-white p-3">
      <table class="w-full border-collapse text-center text-xs">
        {% for row in layout_grid %}
        {% set row_index = loop.index0 %}
        <tr>
          {% for seat in row %}
          <td class="border border-slate-200 p-1">
            <input
              type="checkbox"
              name="layout_cell_{{ row_index }}_{{ loop.index0 }}"
              {% if seat %}checked{% endif %}
              class="h-4 w-4"
            />
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </table>
    </div>
    <textarea
      name="layout_map"
      rows="4"
      class="w-full rounded-lg border border-slate-300 bg-white p-3 font-mono text-xs text-slate-800 shadow-sm"
      placeholder="X...X."
    >{{ layout_map }}</textarea>
  </div>
</div>

<div id="tab-chart" class="tabs-content tabs-panel py-6 px-4 hidden">
  <div class="space-y-4">
    <div>
      <label class="block text-sm font-semibold mb-3">Current seating arrangement:</label>
    </div>
    {% include "partials/_chart.html" %}
  </div>
</div>

<div id="tab-score" class="tabs-content tabs-panel py-6 px-4 hidden">
  <div class="space-y-6">
    <div>
      <label class="block text-sm font-semibold mb-3">Chart fitness metrics:</label>
      {% include "partials/_score.html" %}
    </div>
    <div class="tabs-save-panel rounded-lg border border-slate-200 bg-slate-50 p-4">
      <label class="block text-xs font-semibold uppercase tracking-wide text-slate-500 mb-3">Save current chart</label>
      <div class="flex gap-2 mb-4">
        <input
          type="text"
          name="save_name"
          placeholder="e.g. period-1-jan"
          class="flex-1 rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
        />
        <button
          type="button"
          class="rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow"
          hx-post="/save"
          hx-target="#app"
          hx-include="#controls-form"
        >
          Save
        </button>
      </div>
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-500 mb-3">Load saved charts</p>
        <div class="flex flex-wrap gap-2">
          {% if saves %}
            {% for name in saves %}
            <button
              type="button"
              class="rounded-md border border-slate-300 bg-white px-3 py-1 text-xs font-semibold text-slate-700 shadow-sm hover:bg-slate-50"
              hx-get="/load?name={{ name }}"
              hx-target="#app"
            >
              {{ name }}
            </button>
            {% endfor %}
          {% else %}
            <span class="text-xs text-slate-500">No saved charts yet.</span>
          {% endif %}
        </div>
      </div>
    </div>

    {% if message %}
      <div class="rounded-md border border-indigo-200 bg-indigo-50 px-3 py-2 text-sm text-indigo-700">
        {{ message }}
      </div>
    {% endif %}

    {% if warnings %}
      <ul class="rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-xs text-amber-700">
        {% for warning in warnings %}
        <li>âš  {{ warning }}</li>
        {% endfor %}
      </ul>
    {% endif %}
  </div>
</div>

<script>
function switchTab(event, tabName) {
  event.preventDefault();
  const tabs = document.querySelectorAll('.tabs-content');
  const buttons = document.querySelectorAll('.tabs-trigger');

  tabs.forEach(tab => tab.classList.add('hidden'));
  buttons.forEach(btn => {
    btn.classList.remove('border-b-2', 'border-indigo-600', 'text-indigo-600');
    btn.classList.add('text-slate-600', 'hover:text-slate-900');
  });

  document.getElementById('tab-' + tabName).classList.remove('hidden');
  event.target.classList.add('border-b-2', 'border-indigo-600', 'text-indigo-600');
  event.target.classList.remove('text-slate-600', 'hover:text-slate-900');
  try {
    sessionStorage.setItem('parambulatorActiveTab', tabName);
  } catch (error) {
    // Ignore storage errors.
  }
}

// Initialize first tab on page load
document.addEventListener('DOMContentLoaded', function() {
  let preferredTab = 'people';
  try {
    const savedTab = sessionStorage.getItem('parambulatorActiveTab');
    if (savedTab) {
      preferredTab = savedTab;
    }
  } catch (error) {
    preferredTab = 'people';
  }

  const preferredButton = document.querySelector(`.tabs-trigger[data-tab="${preferredTab}"]`);
  const fallbackButton = document.querySelector('.tabs-trigger[data-tab="people"]');
  const activeButton = preferredButton || fallbackButton;
  const activeTab = preferredButton ? preferredTab : 'people';
  if (activeButton) {
    switchTab({ preventDefault: () => {}, target: activeButton }, activeTab);
  }
});
</script>
